<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <springProperty scope="context" name="APP_NAME" source="spring.application.name"/>

    <property name="DEPLOYMENT_ENV" value="${DEPLOYMENT_ENV:-local}"/>
    <property name="LOG_LEVEL_ROOT" value="${LOG_LEVEL_ROOT:-INFO}"/>

    <property name="LOG_DIR" value="${RETAIL_LOGS_DIR:-../logs}"/>
    <property name="LOG_FILE" value="${LOG_DIR}/${APP_NAME}.json"/>

    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>

                <timestamp>
                    <timeZone>UTC</timeZone>
                </timestamp>

                <pattern>
                    <pattern>{"service":"${APP_NAME}","env":"${DEPLOYMENT_ENV}"}</pattern>
                </pattern>

                <logLevel/>
                <loggerName/>
                <threadName/>
                <message/>

                <mdc>
                    <includeMdcKeyName>trace_id</includeMdcKeyName>
                    <includeMdcKeyName>span_id</includeMdcKeyName>
                    <includeMdcKeyName>trace_flags</includeMdcKeyName>

                    <includeMdcKeyName>correlation_id</includeMdcKeyName>
                    <includeMdcKeyName>parent_correlation_id</includeMdcKeyName>
                    <includeMdcKeyName>order_id</includeMdcKeyName>
                    <includeMdcKeyName>aggregate_id</includeMdcKeyName>
                    <includeMdcKeyName>aggregate_type</includeMdcKeyName>

                    <includeMdcKeyName>saga_id</includeMdcKeyName>
                    <includeMdcKeyName>saga_name</includeMdcKeyName>
                    <includeMdcKeyName>saga_step</includeMdcKeyName>

                    <includeMdcKeyName>command_id</includeMdcKeyName>
                    <includeMdcKeyName>command_type</includeMdcKeyName>
                    <includeMdcKeyName>event_id</includeMdcKeyName>
                    <includeMdcKeyName>event_type</includeMdcKeyName>

                    <includeMdcKeyName>producer</includeMdcKeyName>
                </mdc>

                <stackTrace>
                    <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                        <maxDepthPerThrowable>60</maxDepthPerThrowable>
                        <maxLength>24000</maxLength>
                        <rootCauseFirst>true</rootCauseFirst>
                    </throwableConverter>
                </stackTrace>

            </providers>
        </encoder>
    </appender>


    <appender name="FILE_JSON" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_DIR}/${APP_NAME}.%d{yyyy-MM-dd}.%i.json</fileNamePattern>
            <maxFileSize>20MB</maxFileSize>
            <maxHistory>7</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
            <providers>

                <timestamp>
                    <timeZone>UTC</timeZone>
                </timestamp>

                <pattern>
                    <pattern>{"service":"${APP_NAME}","env":"${DEPLOYMENT_ENV}"}</pattern>
                </pattern>

                <logLevel/>
                <loggerName/>
                <threadName/>
                <message/>

                <mdc>
                    <includeMdcKeyName>trace_id</includeMdcKeyName>
                    <includeMdcKeyName>span_id</includeMdcKeyName>
                    <includeMdcKeyName>trace_flags</includeMdcKeyName>

                    <includeMdcKeyName>correlation_id</includeMdcKeyName>
                    <includeMdcKeyName>parent_correlation_id</includeMdcKeyName>
                    <includeMdcKeyName>order_id</includeMdcKeyName>
                    <includeMdcKeyName>aggregate_id</includeMdcKeyName>
                    <includeMdcKeyName>aggregate_type</includeMdcKeyName>

                    <includeMdcKeyName>saga_id</includeMdcKeyName>
                    <includeMdcKeyName>saga_name</includeMdcKeyName>
                    <includeMdcKeyName>saga_step</includeMdcKeyName>

                    <includeMdcKeyName>command_id</includeMdcKeyName>
                    <includeMdcKeyName>command_type</includeMdcKeyName>
                    <includeMdcKeyName>event_id</includeMdcKeyName>
                    <includeMdcKeyName>event_type</includeMdcKeyName>

                    <includeMdcKeyName>producer</includeMdcKeyName>
                </mdc>

                <stackTrace>
                    <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                        <maxDepthPerThrowable>60</maxDepthPerThrowable>
                        <maxLength>24000</maxLength>
                        <rootCauseFirst>true</rootCauseFirst>
                    </throwableConverter>
                </stackTrace>

            </providers>
        </encoder>
    </appender>

    <root level="${LOG_LEVEL_ROOT}">
        <appender-ref ref="STDOUT"/>
        <appender-ref ref="FILE_JSON"/>
    </root>

</configuration>
