{
  "uid": "retail-store-production-kpis",
  "title": "Retail Store - Production KPIs",
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "10s",
  "tags": [
    "retail-store",
    "kpi",
    "production"
  ],
  "time": {
    "from": "now-15m",
    "to": "now"
  },
  "templating": {
    "list": []
  },
  "panels": [
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 1,
      "title": "Availability (%)",
      "gridPos": {
        "x": 0,
        "y": 0,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "avg by (job) (up{job=~\"ms-.*\"}) * 100",
          "refId": "A",
          "legendFormat": "{{job}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 2,
      "title": "Error rate (5xx) %",
      "gridPos": {
        "x": 8,
        "y": 0,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "sum by (service) (rate(http_server_requests_seconds_count{service=~\"ms-.*\",status=~\"5..\"}[5m])) / sum by (service) (rate(http_server_requests_seconds_count{service=~\"ms-.*\"}[5m])) * 100",
          "refId": "A",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 3,
      "title": "Latency p95 (s)",
      "gridPos": {
        "x": 16,
        "y": 0,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, service) (rate(http_server_requests_seconds_bucket{service=~\"ms-.*\"}[5m])))",
          "refId": "A",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 4,
      "title": "Throughput (RPS)",
      "gridPos": {
        "x": 0,
        "y": 8,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "sum by (service) (rate(http_server_requests_seconds_count{service=~\"ms-.*\"}[5m]))",
          "refId": "A",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 5,
      "title": "CPU usage (%)",
      "gridPos": {
        "x": 8,
        "y": 8,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "process_cpu_usage{service=~\"ms-.*\"} * 100",
          "refId": "A",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 6,
      "title": "Heap used (bytes)",
      "gridPos": {
        "x": 16,
        "y": 8,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "jvm_memory_used_bytes{service=~\"ms-.*\",area=\"heap\"}",
          "refId": "A",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 7,
      "title": "DB pool utilization (%)",
      "gridPos": {
        "x": 0,
        "y": 16,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "hikaricp_connections_active{service=~\"ms-.*\"} / hikaricp_connections_max{service=~\"ms-.*\"} * 100",
          "refId": "A",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 8,
      "title": "Kafka consumer lag (top 10)",
      "gridPos": {
        "x": 8,
        "y": 16,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "topk(10, kafka_consumergroup_lag)",
          "refId": "A",
          "legendFormat": "{{consumergroup}}"
        }
      ]
    },
    {
      "type": "timeseries",
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 9,
      "title": "Postgres connections",
      "gridPos": {
        "x": 16,
        "y": 16,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "sum by (datname) (pg_stat_activity_count)",
          "refId": "A",
          "legendFormat": "{{datname}}"
        }
      ]
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "loki"
      },
      "type": "timeseries",
      "fieldConfig": {
        "defaults": {
          "unit": "ops"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 10,
      "title": "Error logs rate",
      "gridPos": {
        "x": 0,
        "y": 24,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "sum by (service) (rate({service=~\"ms-.*\", level=~\"ERROR|error\"}[5m]))",
          "refId": "A",
          "legendFormat": "{{service}}"
        }
      ]
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "loki"
      },
      "type": "timeseries",
      "fieldConfig": {
        "defaults": {
          "unit": "ops"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 11,
      "title": "Order outcomes (logs)",
      "gridPos": {
        "x": 8,
        "y": 24,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "sum by (event_type) (count_over_time({service=\"ms-order\"} | json | event_type=~\"order.placed|order.completed|order.canceled\" [5m]))",
          "refId": "A",
          "legendFormat": "{{event_type}}"
        }
      ]
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "loki"
      },
      "type": "timeseries",
      "fieldConfig": {
        "defaults": {
          "unit": "ops"
        },
        "overrides": []
      },
      "options": {
        "legend": {
          "displayMode": "list",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single"
        },
        "stacking": {
          "mode": "none"
        }
      },
      "id": 12,
      "title": "Payment outcomes (logs)",
      "gridPos": {
        "x": 16,
        "y": 24,
        "w": 8,
        "h": 8
      },
      "targets": [
        {
          "expr": "sum by (event_type) (count_over_time({service=\"ms-payment\"} | json | event_type=~\"payment.authorized|payment.declined|payment.captured|payment.capture_failed|payment.failed\" [5m]))",
          "refId": "A",
          "legendFormat": "{{event_type}}"
        }
      ]
    }
  ]
}
